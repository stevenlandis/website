<!DOCTYPE html><html lang="en"><head><title>Rule Inputs</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image" href="../rec/favicon/16x16.png" sizes="16x16"/><link rel="icon" type="image" href="../rec/favicon/32x32.png" sizes="32x32"/><link rel="icon" type="image" href="../rec/favicon/96x96.png" sizes="96x96"/><link rel="stylesheet" href="../rec/styles.css"/><link rel="stylesheet" href="../rec/highlight.css"/></head><body><div class="main"><div class="title">Rule Inputs</div><div class="navbar"><span><a href="..//">Home</a></span><span><a style="margin-left:3em;" href="../resume">Resume</a></span><span><a style="margin-left:3em;" href="../postsList">Posts</a></span><span><a style="margin-left:3em;" href="../fractalGenerator/fractal">Fractal Generator</a></span></div><p>This post discusses how to find dependencies for <a href="bld" title="bld">bld</a>, a project builder I made.</p>
<p>Rules have inputs (dependencies) and outputs (results). For bld, these inputs and outputs are files, but they could be many other things such as variables. Bld only lets users declare inputs and outputs before running a rule but there is another way.</p>
<p>Let's say you are baking a cake and you want to know which ingredients to use for each step. The recipe can specify ingredients in two different ways:</p>
<ol>
<li>Listing the ingredients before the recipe and referencing them throughout the recipe.</li>
<li>Specifying the ingredients throughout the recipe.</li>
</ol>
<p>It's the difference between</p>
<pre class="code codeblock"><code>1. Mix ingredients
  - 1 cup flour
  - 1 cup water

  Mix the flour and water in a bowl.

2. Bake the dough
  - Dough mixture
  - A pan
  - A hot oven

  Pour the dough mixture into a pan.
  Bake for 20 minutes.</code></pre><p>and</p>
<pre class="code codeblock"><code>1. Mix 1 cup flour and 1 cup water in a bowl.
2. Pour the dough mixture into a pan and
   bake for 20 minutes.</code></pre><p>The first recipe makes it clear what the cook needs to do for each step but makes more work for the recipe writer.</p>
<p>In the second recipe, ingredients are implied by the instructions which is easier for the recipe writer but harder to see required ingredients. I would rather write a program using the second approach and use a program analysis tool to create the first form.</p>
<p>Consider the following code snippet:</p>
<pre class="code codeblock"><code><span></span><span class="c1">// The function wait(cond, fcn) waits until condition is true</span>
<span class="c1">// to run fcn.</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set a and b&#39;</span><span class="p">);</span>

<span class="nx">wait</span><span class="p">(</span><span class="nx">a</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;a and b are both true!&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set up wait function&#39;</span><span class="p">);</span>

<span class="nx">a</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set a to true&#39;</span><span class="p">);</span>

<span class="nx">b</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set b to true&#39;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm">OUTPUT</span>
<span class="cm">&gt; set a and b</span>
<span class="cm">&gt; set up wait function</span>
<span class="cm">&gt; set a to true</span>
<span class="cm">&gt; a and b are both true!</span>
<span class="cm">&gt; set b to true</span>
<span class="cm">*/</span>
</code></pre><p>This isn't achievable with normal javascript, but a few small changes would make this program possible.</p>
<pre class="code codeblock"><code><span></span><span class="c1">// The function wait(cond, fcn) waits until condition is true</span>
<span class="c1">// to run fcn.</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set a and b&#39;</span><span class="p">);</span>

<span class="nx">wait</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">get</span><span class="p">()},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;a and b are both true!&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set up wait function&#39;</span><span class="p">);</span>

<span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set a to true&#39;</span><span class="p">);</span>

<span class="nx">b</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set b to true&#39;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm">OUTPUT</span>
<span class="cm">&gt; set a and b</span>
<span class="cm">&gt; set up wait function</span>
<span class="cm">&gt; set a to true</span>
<span class="cm">&gt; a and b are both true!</span>
<span class="cm">&gt; set b to true</span>
<span class="cm">*/</span>
</code></pre><p>Just like the second recipe approach, <code class="code codespan">wait()</code> remembers what variables it's condition uses when it first runs. Whenever one of those variables changes, it re-runs the condition. When both <code class="code codespan">a</code> and <code class="code codespan">b</code> are set to <code class="code codespan">true</code>, the waited function finally runs.</p>
<p>This optimization is very efficient because it only checks the condition when one of its dependencies changes. This also creates very clean code and lets the library handle all dependency analysis.</p>
<p>In addition, <code class="code codespan">a</code> or <code class="code codespan">b</code> could be a computed variable:</p>
<pre class="code codeblock"><code><span></span><span class="kd">var</span> <span class="nx">a1</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">a2</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">FcnVar</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">a1</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">||</span> <span class="nx">a2</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="nx">wait</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">get</span><span class="p">()},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;a and b are both true!&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set up wait function&#39;</span><span class="p">);</span>

<span class="nx">a1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#39;set a1 to true&#39;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">OUTPUT</span>
<span class="cm">&gt; set variables</span>
<span class="cm">&gt; set up wait function</span>
<span class="cm">&gt; a and b are both true!</span>
<span class="cm">&gt; set a1 to true</span>
<span class="cm">*/</span>
</code></pre><p>The library automatically figures out that <code class="code codespan">a</code> depends on <code class="code codespan">a1</code> and <code class="code codespan">a2</code>, so changing their values propagates the change up to <code class="code codespan">wait</code>.</p>
</div></body></html>