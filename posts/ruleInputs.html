<!doctype html><html><head><meta charset="UTF-8"><meta charset="UTF-8"><meta name="viewport" content="width=device-width" initial-scale="1.0"><link rel="icon" type="image" href="/favicon/16x16.png" sizes="16x16"><link rel="icon" type="image" href="/favicon/32x32.png" sizes="32x32"><link rel="icon" type="image" href="/favicon/96x96.png" sizes="96x96"><link rel="stylesheet" href="/css/styles.css"><link rel="stylesheet" href="/css/highlight.css"><title>Rule Inputs</title></head><body><div class="title">Rule Inputs</div><div class="main"><div class="navbar"><span><a href="/">Home</a></span><span><a style="margin-left:3em;" href="/resume">Resume</a></span><span><a style="margin-left:3em;" href="/posts/list">Posts</a></span><span><a style="margin-left:3em;" href="/fractal">Fractal Generator</a></span></div><p>This post discusses how to find dependencies for <a href="bld.html">bld</a>, a project builder I made.</p><p>Rules have inputs (dependencies) and outputs (results). For bld, these inputs and outputs are files, but they could be many other things such as variables. Bld only lets users declare inputs and outputs before running a rule but there is another way.</p><p>Let's say you are baking a cake and you want to know which ingredients to use for each step. The recipe can specify ingredients in two different ways:</p><ol><li>Listing the ingredients before the recipe and referencing them throughout the recipe.</li><li>Specifying the ingredients throughout the recipe.</li></ol><p>It's the difference between</p><div class="highlight"><pre><span></span>1. Mix ingredients
  - 1 cup flour
  - 1 cup water

  Mix the flour and water in a bowl.

2. Bake the dough
  - Dough mixture
  - A pan
  - A hot oven

  Pour the dough mixture into a pan.
  Bake for 20 minutes.
</pre></div><p>and</p><div class="highlight"><pre><span></span>1. Mix 1 cup flour and 1 cup water in a bowl.
2. Pour the dough mixture into a pan and
   bake for 20 minutes.
</pre></div><p>The first recipe makes it clear what the cook needs to do for each step but makes more work for the recipe writer.</p><p>In the second recipe, ingredients are implied by the instructions which is easier for the recipe writer but harder to see required ingredients. I would rather write a program using the second approach and use a program analysis tool to create the first form.</p><p>Consider the following code snippet:</p><div class="highlight"><pre><span></span><span class="c1">// The function wait(cond, fcn) waits until condition is true</span>
<span class="c1">// to run fcn.</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set a and b&#x27;</span><span class="p">);</span>

<span class="nx">wait</span><span class="p">(</span><span class="nx">a</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;a and b are both true!&#x27;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set up wait function&#x27;</span><span class="p">);</span>

<span class="nx">a</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set a to true&#x27;</span><span class="p">);</span>

<span class="nx">b</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set b to true&#x27;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm">OUTPUT</span>
<span class="cm">&gt; set a and b</span>
<span class="cm">&gt; set up wait function</span>
<span class="cm">&gt; set a to true</span>
<span class="cm">&gt; a and b are both true!</span>
<span class="cm">&gt; set b to true</span>
<span class="cm">*/</span>
</pre></div><p>This isn't achievable with normal javascript, but a few small changes would make this program possible.</p><div class="highlight"><pre><span></span><span class="c1">// The function wait(cond, fcn) waits until condition is true</span>
<span class="c1">// to run fcn.</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set a and b&#x27;</span><span class="p">);</span>

<span class="nx">wait</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">get</span><span class="p">()},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;a and b are both true!&#x27;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set up wait function&#x27;</span><span class="p">);</span>

<span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set a to true&#x27;</span><span class="p">);</span>

<span class="nx">b</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set b to true&#x27;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm">OUTPUT</span>
<span class="cm">&gt; set a and b</span>
<span class="cm">&gt; set up wait function</span>
<span class="cm">&gt; set a to true</span>
<span class="cm">&gt; a and b are both true!</span>
<span class="cm">&gt; set b to true</span>
<span class="cm">*/</span>
</pre></div><p>Just like the second recipe approach, <code>wait()</code> remembers what variables it's condition uses when it first runs. Whenever one of those variables changes, it re-runs the condition. When both <code>a</code> and <code>b</code> are set to <code>true</code>, the waited function finally runs.</p><p>This optimization is very efficient because it only checks the condition when one of its dependencies changes. This also creates very clean code and lets the library handle all dependency analysis.</p><p>In addition, <code>a</code> or <code>b</code> could be a computed variable:</p><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">a1</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">a2</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">FcnVar</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">a1</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">||</span> <span class="nx">a2</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">Var</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="nx">wait</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">a</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">get</span><span class="p">()},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;a and b are both true!&#x27;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set up wait function&#x27;</span><span class="p">);</span>

<span class="nx">a1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set a1 to true&#x27;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">OUTPUT</span>
<span class="cm">&gt; set up wait function</span>
<span class="cm">&gt; a and b are both true!</span>
<span class="cm">&gt; set a1 to true</span>
<span class="cm">*/</span>
</pre></div><p>The library automatically figures out that <code>a</code> depends on <code>a1</code> and <code>a2</code>, so changing their values propagates the change up to <code>wait</code>.</p><h1><img src="/svg/logo.svg" class="h1-img">Update: Mar 12, 2020</h1><p>I have a working version! I made a few changes and the function works as expected, but I'm running into some unexpected issues with integrating <code>run()</code> into a program. More on that later.</p><p>There are some mild changes. First of all, instead of <code>wait</code>, I switch the function to <code>run</code> because it makes a little more sense. I also changed <code>Var</code> to <code>Ref</code>.</p><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">a1</span> <span class="o">=</span> <span class="nx">Ref</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">a2</span> <span class="o">=</span> <span class="nx">Ref</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">FcnRef</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">a1</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">||</span> <span class="nx">a2</span><span class="p">.</span><span class="nx">get</span><span class="p">());</span>
<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">Ref</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="nx">run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">get</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;a and b are both true!&#x27;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;set up run function&#x27;</span><span class="p">);</span>

<span class="nx">print</span><span class="p">(</span><span class="s1">&#x27;setting a1 to true&#x27;</span><span class="p">);</span>
<span class="nx">a1</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">OUTPUT</span>
<span class="cm">&gt; set up wait function</span>
<span class="cm">&gt; setting a1 to true:</span>
<span class="cm">&gt; a and b are both true!</span>
<span class="cm">*/</span>
</pre></div><p>And there it is. In plain javascript with a minimal syntax, this script is an efficient implementation of dependent variables. This setup means it is possible to use variables with confidence.</p><p>One of the main issues with programming is duplication of source of truth. Dependent programming eliminates this issue because variables are recalculated whenever their value changes. For example, I can confidently use <code>a</code> without worrying about when its value changes. I don't need to re-run my check when <code>a1</code> and <code>a2</code> change because the library takes care of that.</p><p>It's all sunshine and rainbows from here on out, right? Well, it turns out that integrating <code>run</code> into other applications can be a little tricky. For one, it would be nice to cache changed variables until they can be written.</p></div></body></html>